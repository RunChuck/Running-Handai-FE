name: Create GitHub Issue from Jira Subtask

on:
  repository_dispatch:
    types: [jira-subtask-assigned]

permissions:
  issues: write
  contents: read

jobs:
  create-github-issue:
    runs-on: ubuntu-latest
    
    steps:
    - name: Extract Jira Data
      id: extract-data
      run: |
        echo "=== Jira Webhook Data ==="
        echo "Issue Key: ${{ github.event.client_payload.issue_key }}"
        echo "Summary: ${{ github.event.client_payload.summary }}"
        echo "Assignee: ${{ github.event.client_payload.assignee }}"
        echo "Parent Key: ${{ github.event.client_payload.parent_key }}"
        echo "Description: ${{ github.event.client_payload.description }}"
        echo "=========================="
        
        # ë°ì´í„° ì •ë¦¬
        JIRA_KEY="${{ github.event.client_payload.issue_key }}"
        TITLE="${{ github.event.client_payload.summary }}"
        ASSIGNEE="${{ github.event.client_payload.assignee }}"
        PARENT="${{ github.event.client_payload.parent_key }}"
        DESC="${{ github.event.client_payload.description }}"
        
        echo "JIRA_KEY=$JIRA_KEY" >> $GITHUB_OUTPUT
        echo "TITLE=$TITLE" >> $GITHUB_OUTPUT
        echo "ASSIGNEE=$ASSIGNEE" >> $GITHUB_OUTPUT
        echo "PARENT=$PARENT" >> $GITHUB_OUTPUT
        echo "DESC=$DESC" >> $GITHUB_OUTPUT

    - name: Check if assigned to me
      id: check-assignee
      run: |
        ASSIGNEE="${{ steps.extract-data.outputs.ASSIGNEE }}"
        MY_JIRA_EMAIL="${{ secrets.JIRA_USER_EMAIL }}"
        
        if [[ "$ASSIGNEE" == "$MY_JIRA_EMAIL" ]]; then
          echo "âœ… ë‚˜ì—ê²Œ í• ë‹¹ëœ ì‘ì—…ì…ë‹ˆë‹¤"
          echo "CREATE_ISSUE=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ ë‹¤ë¥¸ ì‚¬ëŒì—ê²Œ í• ë‹¹ëœ ì‘ì—…ì…ë‹ˆë‹¤: $ASSIGNEE"
          echo "CREATE_ISSUE=false" >> $GITHUB_OUTPUT
        fi

    - name: Create GitHub Issue
      if: steps.check-assignee.outputs.CREATE_ISSUE == 'true'
      id: create-issue
      uses: actions-cool/issues-helper@v3
      with:
        actions: 'create-issue'
        token: ${{ secrets.GITHUB_TOKEN }}
        title: '[${{ steps.extract-data.outputs.JIRA_KEY }}] ${{ steps.extract-data.outputs.TITLE }}'
        body: |
          ## ğŸ¯ Jira Sub-taskì—ì„œ ìë™ ìƒì„±
          
          **ğŸŸï¸ Jira í‹°ì¼“ ë§í¬**: [${{ steps.extract-data.outputs.JIRA_KEY }}](${{ secrets.JIRA_BASE_URL }}/browse/${{ steps.extract-data.outputs.JIRA_KEY }})
          **ğŸ“Š ìƒìœ„ í‹°ì¼“**: [${{ steps.extract-data.outputs.PARENT }}](${{ secrets.JIRA_BASE_URL }}/browse/${{ steps.extract-data.outputs.PARENT }})
          **ğŸ‘¤ ë‹´ë‹¹ì**: ${{ steps.extract-data.outputs.ASSIGNEE }}
          
          ## ğŸ“ ì‘ì—… ì„¤ëª…
          ${{ steps.extract-data.outputs.DESC }}
          
          ---
          > ğŸ’¡ ì´ ì´ìŠˆëŠ” PMì´ Jiraì—ì„œ í•˜ìœ„ ì‘ì—…ì„ í• ë‹¹í–ˆì„ ë•Œ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.

    - name: Add Development Checklist
      if: steps.check-assignee.outputs.CREATE_ISSUE == 'true'
      uses: actions-cool/issues-helper@v3
      with:
        actions: 'create-comment'
        token: ${{ secrets.GITHUB_TOKEN }}
        issue-number: ${{ steps.create-issue.outputs.issue-number }}
        body: |
          ğŸš€ ** ì²´í¬ë¦¬ìŠ¤íŠ¸**
          
          - [ ] ìš”êµ¬ì‚¬í•­ ë¶„ì„ ì™„ë£Œ
          - [ ] ê¸°ìˆ  ìŠ¤íƒ ë° êµ¬í˜„ ë°©ë²• ê²€í† 
          - [ ] ë¸Œëœì¹˜ ìƒì„± ë° í™˜ê²½ ì„¤ì •
          
          **ê´€ë ¨ Jira**: [${{ steps.extract-data.outputs.JIRA_KEY }}](${{ secrets.JIRA_BASE_URL }}/browse/${{ steps.extract-data.outputs.JIRA_KEY }})