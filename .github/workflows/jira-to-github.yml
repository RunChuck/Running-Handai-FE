name: Create GitHub Issue from Jira Subtask

on:
  repository_dispatch:
    types: [jira-subtask-assigned]

permissions:
  issues: write
  contents: read

jobs:
  create-github-issue:
    runs-on: ubuntu-latest

    steps:
      - name: Extract Jira Data
        id: extract-data
        run: |
          echo "=== Jira Webhook Data ==="
          echo "Issue Key: ${{ github.event.client_payload.issue_key }}"
          echo "Summary: ${{ github.event.client_payload.summary }}"
          echo "Assignee: ${{ github.event.client_payload.assignee }}"
          echo "Parent Key: ${{ github.event.client_payload.parent_key }}"
          echo "Description: (ì²˜ë¦¬ ì¤‘...)"
          echo "=========================="

          # ë°ì´í„° ì •ë¦¬ - base64 ì¸ì½”ë”©ìœ¼ë¡œ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
          JIRA_KEY="${{ github.event.client_payload.issue_key }}"
          TITLE="${{ github.event.client_payload.summary }}"
          ASSIGNEE="${{ github.event.client_payload.assignee }}"
          PARENT="${{ github.event.client_payload.parent_key }}"

          # Descriptionì„ base64ë¡œ ì¸ì½”ë”©í•˜ì—¬ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
          DESC_RAW="${{ github.event.client_payload.description }}"
          if [ -n "$DESC_RAW" ]; then
            DESC_B64=$(echo -n "$DESC_RAW" | base64 -w 0)
          else
            DESC_B64=""
          fi

          echo "JIRA_KEY=$JIRA_KEY" >> $GITHUB_OUTPUT
          echo "TITLE=$TITLE" >> $GITHUB_OUTPUT
          echo "ASSIGNEE=$ASSIGNEE" >> $GITHUB_OUTPUT
          echo "PARENT=$PARENT" >> $GITHUB_OUTPUT
          echo "DESC_B64=$DESC_B64" >> $GITHUB_OUTPUT

      - name: Check if assigned to me
        id: check-assignee
        run: |
          ASSIGNEE="${{ steps.extract-data.outputs.ASSIGNEE }}"
          MY_JIRA_EMAIL="${{ secrets.JIRA_USER_EMAIL }}"

          if [[ "$ASSIGNEE" == "$MY_JIRA_EMAIL" ]]; then
            echo "âœ… ë‚˜ì—ê²Œ í• ë‹¹ëœ ì‘ì—…ì…ë‹ˆë‹¤"
            echo "CREATE_ISSUE=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ ë‹¤ë¥¸ ì‚¬ëŒì—ê²Œ í• ë‹¹ëœ ì‘ì—…ì…ë‹ˆë‹¤: $ASSIGNEE"
            echo "CREATE_ISSUE=false" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Issue
        if: steps.check-assignee.outputs.CREATE_ISSUE == 'true'
        id: create-issue
        run: |
          # base64 ë””ì½”ë”©í•˜ì—¬ description ë³µì›
          if [ -n "${{ steps.extract-data.outputs.DESC_B64 }}" ]; then
            DESC_RAW=$(echo "${{ steps.extract-data.outputs.DESC_B64 }}" | base64 -d)
            # Jira ì´ë¯¸ì§€ ë§ˆí¬ì—… ì œê±° (!image.ext|...! í˜•íƒœ)
            DESC_DECODED=$(echo "$DESC_RAW" | sed 's/!image-[^!]*\.png[^!]*!//g' | sed 's/!image-[^!]*\.jpg[^!]*!//g' | sed 's/!image-[^!]*\.jpeg[^!]*!//g' | sed 's/!image-[^!]*\.gif[^!]*!//g')
          else
            DESC_DECODED="(ì„¤ëª… ì—†ìŒ)"
          fi

          # GitHub ì´ìŠˆ ìƒì„±ì„ ìœ„í•œ JSON í˜ì´ë¡œë“œ ì¤€ë¹„
          ISSUE_TITLE="[${{ steps.extract-data.outputs.JIRA_KEY }}] ${{ steps.extract-data.outputs.TITLE }}"

          ISSUE_BODY=$(cat <<EOF
          ## ğŸ“Œ Jira ì •ë³´

          **ğŸŸï¸ ì´ìŠˆ í‹°ì¼“**: [${{ steps.extract-data.outputs.JIRA_KEY }}](${{ secrets.JIRA_BASE_URL }}/browse/${{ steps.extract-data.outputs.JIRA_KEY }})
          **ğŸ“ ìƒìœ„ í‹°ì¼“**: [${{ steps.extract-data.outputs.PARENT }}](${{ secrets.JIRA_BASE_URL }}/browse/${{ steps.extract-data.outputs.PARENT }})

          ## ğŸ“ ì‘ì—… ì„¤ëª…
          ${DESC_DECODED}

          ---
          > ğŸ’¡ ì´ ì´ìŠˆëŠ” Jira ì‘ì—…ê³¼ ì—°ë™ë˜ì–´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
          EOF
          )

          # GitHub APIë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ìŠˆ ìƒì„± (í• ë‹¹ì í¬í•¨)
          RESPONSE=$(curl -s -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues" \
            -d "{
              \"title\": $(echo "$ISSUE_TITLE" | jq -R .),
              \"body\": $(echo "$ISSUE_BODY" | jq -Rs .),
              \"assignees\": [\"InKyungWoo\"]
            }")

          ISSUE_NUMBER=$(echo "$RESPONSE" | jq -r '.number')
          ISSUE_ID=$(echo "$RESPONSE" | jq -r '.id')

          echo "ISSUE_NUMBER=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          echo "ISSUE_ID=$ISSUE_ID" >> $GITHUB_OUTPUT
          echo "âœ… GitHub ì´ìŠˆ #$ISSUE_NUMBER ìƒì„± ì™„ë£Œ"

      - name: Add to Organization Project
        if: steps.check-assignee.outputs.CREATE_ISSUE == 'true'
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN }}
        run: |
          ISSUE_NUMBER="${{ steps.create-issue.outputs.ISSUE_NUMBER }}"

          # GitHub CLIë¥¼ ì‚¬ìš©í•˜ì—¬ í”„ë¡œì íŠ¸ì— ì¶”ê°€
          gh project item-add 2 --owner RunChuck --url "https://github.com/${{ github.repository }}/issues/${ISSUE_NUMBER}"
          echo "âœ… ì´ìŠˆ #${ISSUE_NUMBER}ë¥¼ í”„ë¡œì íŠ¸ì— ì¶”ê°€ ì™„ë£Œ"

      - name: Set Active Milestone
        if: steps.check-assignee.outputs.CREATE_ISSUE == 'true'
        run: |
          ISSUE_NUMBER="${{ steps.create-issue.outputs.ISSUE_NUMBER }}"

          # í™œì„± milestone ì°¾ê¸° (open ìƒíƒœì¸ ê²ƒë“¤)
          MILESTONES=$(curl -s \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/milestones?state=open")

          MILESTONE_COUNT=$(echo "$MILESTONES" | jq 'length')

          if [ "$MILESTONE_COUNT" -eq 1 ]; then
            # í™œì„± milestoneì´ ì •í™•íˆ í•˜ë‚˜ì¼ ë•Œë§Œ ì„¤ì •
            MILESTONE_NUMBER=$(echo "$MILESTONES" | jq -r '.[0].number')

            # ì´ìŠˆì— milestone ì„¤ì •
            curl -s -X PATCH \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/issues/${ISSUE_NUMBER}" \
              -d "{
                \"milestone\": $MILESTONE_NUMBER
              }"

            echo "âœ… ì´ìŠˆ #${ISSUE_NUMBER}ì— milestone #${MILESTONE_NUMBER} ì„¤ì • ì™„ë£Œ"
          elif [ "$MILESTONE_COUNT" -eq 0 ]; then
            echo "â„¹ï¸ í™œì„± milestoneì´ ì—†ì–´ ì„¤ì •í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
          else
            echo "â„¹ï¸ í™œì„± milestoneì´ ${MILESTONE_COUNT}ê°œ ìˆì–´ ì„¤ì •í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
          fi
