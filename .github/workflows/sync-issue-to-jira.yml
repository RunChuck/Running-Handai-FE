name: Create Jira Subtask from GitHub Issue

on:
  issues:
    types: [opened, labeled]

jobs:
  create-jira-subtask:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'jira-sync')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Parse Issue Template
      uses: stefanbuck/github-issue-praser@v3
      id: issue-parser
      with:
        template-path: .github/ISSUE_TEMPLATE/issue_form.yml
        
    - name: Debug Issue Parser Output
      run: |
        echo "=== Issue Parser Outputs ==="
        echo "Parent Ticket: '${{ steps.issue-parser.outputs.issueparser_parent-ticket }}'"
        echo "Task Title: '${{ steps.issue-parser.outputs.issueparser_task-title }}'"
        echo "Assignee: '${{ steps.issue-parser.outputs.issueparser_assignee }}'"
        echo "JSON: ${{ steps.issue-parser.outputs.jsonString }}"
        echo "=========================="

    - name: Login to Jira
      uses: atlassian/gajira-login@v3
      env:
        JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
        JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}

    - name: Convert markdown to Jira format
      uses: peter-evans/jira2md@v1
      id: md2jira
      with:
        input-text: |
          ğŸ”— GitHub Issueì—ì„œ ìë™ ìƒì„±ë¨: ${{ github.event.issue.html_url }}
          
          ${{ steps.issue-parser.outputs.issueparser_task-description }}
        mode: md2jira

    - name: Create Jira Subtask
      id: create-subtask
      uses: atlassian/gajira-create@v3
      with:
        project: SCRUM
        issuetype: Sub-task
        summary: '${{ steps.issue-parser.outputs.issueparser_task-title }}'
        description: '${{ steps.md2jira.outputs.output-text }}'
        fields: |
          {
            "parent": {
              "key": "${{ steps.issue-parser.outputs.issueparser_parent-ticket }}"
            }
          }

    - name: Update GitHub Issue Title
      uses: actions-cool/issues-helper@v3
      with:
        actions: 'update-issue'
        token: ${{ secrets.GITHUB_TOKEN }}
        title: '[${{ steps.create-subtask.outputs.issue }}] ${{ github.event.issue.title }}'

    - name: Add Success Comment
      uses: actions-cool/issues-helper@v3
      with:
        actions: 'create-comment'
        token: ${{ secrets.GITHUB_TOKEN }}
        issue-number: ${{ github.event.issue.number }}
        body: |
          ğŸ‰ **Jira ì—°ë™ ì™„ë£Œ!**
          
          ğŸ“‹ **ìƒì„±ëœ í•˜ìœ„ íƒœìŠ¤í¬**: [${{ steps.create-subtask.outputs.issue }}](${{ secrets.JIRA_BASE_URL }}/browse/${{ steps.create-subtask.outputs.issue }})
          ğŸ“Š **ìƒìœ„ íƒœìŠ¤í¬**: [${{ steps.issue-parser.outputs.issueparser_parent-ticket }}](${{ secrets.JIRA_BASE_URL }}/browse/${{ steps.issue-parser.outputs.issueparser_parent-ticket }})
          
          > ğŸ’¡ ì´ì œ Jiraì—ì„œ í•´ë‹¹ í•˜ìœ„ íƒœìŠ¤í¬ë¡œ ë¸Œëœì¹˜ë¥¼ ìƒì„±í•˜ê³  ì‘ì—…ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!

    - name: Add jira-linked label
      uses: actions-cool/issues-helper@v3
      with:
        actions: 'add-labels'
        token: ${{ secrets.GITHUB_TOKEN }}
        labels: 'jira-linked'
