name: Create Jira Subtask from GitHub Issue

on:
  issues:
    types: [opened]

permissions:
  issues: write
  contents: read

jobs:
  create-jira-subtask:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'jira-sync')
    
    concurrency:
      group: jira-sync-${{ github.event.issue.number }}
      cancel-in-progress: true
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Parse Issue Template
      uses: stefanbuck/github-issue-parser@v3
      id: issue-parser
      with:
        template-path: .github/ISSUE_TEMPLATE/issue_form.yml
        
    - name: Debug Issue Parser Output
      run: |
        echo "=== Issue Parser Outputs ==="
        echo "Parent Ticket: '${{ steps.issue-parser.outputs.issueparser_parent-ticket }}'"
        echo "Task Title: '${{ steps.issue-parser.outputs.issueparser_task-title }}'"
        echo "Assignee: '${{ steps.issue-parser.outputs.issueparser_assignee }}'"
        echo "All outputs:"
        echo '${{ toJson(steps.issue-parser.outputs) }}'
        echo "=========================="

    - name: Login to Jira
      uses: atlassian/gajira-login@v3
      env:
        JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
        JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}

    - name: Prepare Sub-task Data
      id: prepare-data
      run: |
        echo "🔍 Sub-task 생성 준비..."
        PARENT_TICKET="${{ steps.issue-parser.outputs.issueparser_parent-ticket }}"
        
        echo "상위 티켓: $PARENT_TICKET"
        echo "태스크 제목: ${{ steps.issue-parser.outputs.issueparser_task-title }}"
        
        echo "PARENT_TICKET=$PARENT_TICKET" >> $GITHUB_OUTPUT
        echo "TASK_TITLE=${{ steps.issue-parser.outputs.issueparser_task-title }}" >> $GITHUB_OUTPUT

    - name: Convert markdown to Jira format
      uses: peter-evans/jira2md@v1
      id: md2jira
      with:
        input-text: |
          h2. GitHub Issue에서 생성된 태스크
          * GitHub Issue URL: ${{ github.event.issue.html_url }}
          * 생성자: ${{ github.event.issue.user.login }}
          
          h2. 작업 설명
          ${{ steps.issue-parser.outputs.issueparser_task-description }}
        mode: md2jira

    - name: Create Subtask using Gajira
      id: create-jira-subtask
      uses: atlassian/gajira-create@v3
      with:
        project: SCRUM
        issuetype: "Sub-task"
        summary: '${{ steps.prepare-data.outputs.TASK_TITLE }}'
        description: '${{ steps.md2jira.outputs.output-text }}'
        fields: |
          {
            "parent": {
              "key": "${{ steps.prepare-data.outputs.PARENT_TICKET }}"
            }
          }

    - name: Check Results and Set Final Issue
      id: set-issue-key
      run: |
        echo "=== 생성 결과 확인 ==="
        
        if [[ "${{ steps.create-jira-subtask.outcome }}" == "success" && -n "${{ steps.create-jira-subtask.outputs.issue }}" ]]; then
          echo "✅ Sub-task 생성 성공: ${{ steps.create-jira-subtask.outputs.issue }}"
          echo "FINAL_ISSUE=${{ steps.create-jira-subtask.outputs.issue }}" >> $GITHUB_OUTPUT
          echo "SUCCESS=true" >> $GITHUB_OUTPUT
          echo "ISSUE_TYPE=Sub-task" >> $GITHUB_OUTPUT
        else
          echo "❌ Sub-task 생성 실패"
          echo "생성 결과: ${{ steps.create-jira-subtask.outcome }}"
          echo ""
          echo "💡 수동으로 Jira에서 Sub-task를 생성해주세요:"
          echo "   상위 이슈: ${{ steps.prepare-data.outputs.PARENT_TICKET }}"
          echo "   제목: ${{ steps.prepare-data.outputs.TASK_TITLE }}"
          echo "SUCCESS=false" >> $GITHUB_OUTPUT
          exit 1
        fi

    - name: Add Success Comment
      if: steps.set-issue-key.outputs.SUCCESS == 'true'
      uses: actions-cool/issues-helper@v3
      with:
        actions: 'create-comment'
        token: ${{ secrets.GITHUB_TOKEN }}
        issue-number: ${{ github.event.issue.number }}
        body: |
          🎉 **Jira 연동 완료!**
          
          📋 **생성된 이슈**: [${{ steps.set-issue-key.outputs.FINAL_ISSUE }}](${{ secrets.JIRA_BASE_URL }}/browse/${{ steps.set-issue-key.outputs.FINAL_ISSUE }}) (타입: ${{ steps.set-issue-key.outputs.ISSUE_TYPE }})
          📊 **상위 태스크**: [${{ steps.issue-parser.outputs.issueparser_parent-ticket }}](${{ secrets.JIRA_BASE_URL }}/browse/${{ steps.issue-parser.outputs.issueparser_parent-ticket }})
          
          > 💡 이제 Jira에서 해당 태스크로 브랜치를 생성하고 작업을 시작할 수 있습니다!

    - name: Add Failure Comment
      if: failure()
      uses: actions-cool/issues-helper@v3
      with:
        actions: 'create-comment'
        token: ${{ secrets.GITHUB_TOKEN }}
        issue-number: ${{ github.event.issue.number }}
        body: |
          ❌ **Jira Sub-task 생성 실패**
          
          자동으로 Jira 하위 태스크를 생성하는데 실패했습니다.
          
          **수동 생성 정보:**
          - 상위 티켓: `${{ steps.issue-parser.outputs.issueparser_parent-ticket }}`
          - 제목: `${{ steps.issue-parser.outputs.issueparser_task-title }}`
          - GitHub Issue: ${{ github.event.issue.html_url }}
          
          **가능한 원인:**
          - API 토큰 권한 부족 (일반 구성원은 Sub-task 생성 제한)
          - 프로젝트 설정에서 API를 통한 Sub-task 생성 비활성화
          - Story 상태나 Sprint 설정 문제
          
          > 💡 Jira 웹에서 수동으로 하위 작업을 생성해주세요.