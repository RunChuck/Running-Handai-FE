name: Create Jira Subtask from GitHub Issue

on:
  issues:
    types: [opened, labeled]

jobs:
  create-jira-subtask:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'jira-sync')
    
    steps:
    - name: Parse Issue Template Data
      id: parse
      run: |
        # GitHub ì´ìŠˆ ë³¸ë¬¸ì—ì„œ í…œí”Œë¦¿ ë°ì´í„° ì¶”ì¶œ
        ISSUE_BODY='${{ github.event.issue.body }}'
        
        # ê° í•„ë“œ ì¶”ì¶œ (GitHub Issue Form í˜•ì‹)
        PARENT_TICKET=$(echo "$ISSUE_BODY" | grep -A1 "### ğŸŸï¸ ìƒìœ„ Jira í‹°ì¼“" | tail -1 | xargs)
        TASK_TITLE=$(echo "$ISSUE_BODY" | grep -A1 "### ğŸ¯ íƒœìŠ¤í¬ ì œëª©" | tail -1 | xargs)
        ASSIGNEE=$(echo "$ISSUE_BODY" | grep -A1 "### ğŸ‘¤ ë‹´ë‹¹ì" | tail -1 | xargs)
        
        # ì‘ì—… ì„¤ëª…ì€ ì—¬ëŸ¬ ì¤„ì´ë¯€ë¡œ ë³„ë„ ì²˜ë¦¬
        TASK_DESC=$(echo "$ISSUE_BODY" | sed -n '/### ğŸ“ ì‘ì—… ì„¤ëª…/,/### /p' | sed '1d;$d' | sed 's/^[[:space:]]*//')
        
        # GitHub ì´ìŠˆ ì •ë³´
        ISSUE_URL="${{ github.event.issue.html_url }}"
        ISSUE_NUMBER="${{ github.event.issue.number }}"
        
        # ì¶œë ¥ ë³€ìˆ˜ ì„¤ì •
        echo "PARENT_TICKET=$PARENT_TICKET" >> $GITHUB_OUTPUT
        echo "TASK_TITLE=$TASK_TITLE" >> $GITHUB_OUTPUT
        echo "ASSIGNEE=$ASSIGNEE" >> $GITHUB_OUTPUT
        echo "ISSUE_URL=$ISSUE_URL" >> $GITHUB_OUTPUT
        echo "ISSUE_NUMBER=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
        
        # ë©€í‹°ë¼ì¸ í…ìŠ¤íŠ¸ ì²˜ë¦¬
        echo "TASK_DESC<<EOF" >> $GITHUB_OUTPUT
        echo "$TASK_DESC" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        echo "âœ… íŒŒì‹± ì™„ë£Œ"
        echo "ìƒìœ„ í‹°ì¼“: $PARENT_TICKET"
        echo "íƒœìŠ¤í¬ ì œëª©: $TASK_TITLE"
        echo "ë‹´ë‹¹ì: $ASSIGNEE"

    - name: Validate Parent Ticket
      id: validate
      run: |
        PARENT_TICKET="${{ steps.parse.outputs.PARENT_TICKET }}"
        
        # ìƒìœ„ í‹°ì¼“ í™•ì¸
        if [[ -z "$PARENT_TICKET" || "$PARENT_TICKET" == "_No response_" ]]; then
          echo "âŒ ìƒìœ„ í‹°ì¼“ì´ ì§€ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
          exit 1
        fi
        
        # Jira APIë¡œ ìƒìœ„ í‹°ì¼“ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
        RESPONSE=$(curl -s -w "%{http_code}" -o /tmp/parent_check.json \
          -H "Authorization: Basic $(echo -n '${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}' | base64)" \
          '${{ secrets.JIRA_BASE_URL }}/rest/api/3/issue/'$PARENT_TICKET)
        
        HTTP_CODE=$(tail -n1 <<< "$RESPONSE")
        
        if [[ "$HTTP_CODE" != "200" ]]; then
          echo "âŒ ìƒìœ„ í‹°ì¼“ '$PARENT_TICKET'ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
          echo "HTTP ì‘ë‹µ ì½”ë“œ: $HTTP_CODE"
          cat /tmp/parent_check.json
          exit 1
        fi
        
        echo "âœ… ìƒìœ„ í‹°ì¼“ í™•ì¸ ì™„ë£Œ: $PARENT_TICKET"

    - name: Create Jira Subtask
      id: create-subtask
      run: |
        # ë‹´ë‹¹ì í•„ë“œ ì„¤ì •
        ASSIGNEE="${{ steps.parse.outputs.ASSIGNEE }}"
        ASSIGNEE_FIELD=""
        
        if [[ -n "$ASSIGNEE" && "$ASSIGNEE" != "_No response_" && "$ASSIGNEE" != "No response" ]]; then
          ASSIGNEE_FIELD='"assignee": {"emailAddress": "'$ASSIGNEE'"},'
        fi
        
        # ì‘ì—… ì„¤ëª… JSON ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬
        TASK_DESC='${{ steps.parse.outputs.TASK_DESC }}'
        TASK_DESC_ESCAPED=$(echo "$TASK_DESC" | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')
        
        # Jira í•˜ìœ„ íƒœìŠ¤í¬ ìƒì„± API í˜¸ì¶œ
        echo "ğŸš€ Jira í•˜ìœ„ íƒœìŠ¤í¬ ìƒì„± ì¤‘..."
        
        RESPONSE=$(curl -X POST \
          -H "Content-Type: application/json" \
          -H "Authorization: Basic $(echo -n '${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}' | base64)" \
          -d '{
            "fields": {
              "project": {
                "key": "SCRUM"
              },
              "parent": {
                "key": "${{ steps.parse.outputs.PARENT_TICKET }}"
              },
              "summary": "${{ steps.parse.outputs.TASK_TITLE }}",
              "description": {
                "type": "doc",
                "version": 1,
                "content": [
                  {
                    "type": "paragraph",
                    "content": [
                      {
                        "type": "text",
                        "text": "ğŸ”— GitHub Issueì—ì„œ ìë™ ìƒì„±ë¨: ${{ steps.parse.outputs.ISSUE_URL }}"
                      }
                    ]
                  },
                  {
                    "type": "rule"
                  },
                  {
                    "type": "paragraph",
                    "content": [
                      {
                        "type": "text",
                        "text": "'"$TASK_DESC_ESCAPED"'"
                      }
                    ]
                  }
                ]
              },
              "issuetype": {
                "name": "Sub-task"
              },
              '"$ASSIGNEE_FIELD"'
              "labels": ["github-auto", "subtask"]
            }
          }' \
          '${{ secrets.JIRA_BASE_URL }}/rest/api/3/issue')
        
        # ì‘ë‹µ í™•ì¸ ë° í‹°ì¼“ í‚¤ ì¶”ì¶œ
        echo "API ì‘ë‹µ: $RESPONSE"
        
        JIRA_KEY=$(echo $RESPONSE | jq -r '.key // empty')
        ERROR_MESSAGE=$(echo $RESPONSE | jq -r '.errorMessages[]? // empty')
        
        if [[ -z "$JIRA_KEY" || "$JIRA_KEY" == "null" ]]; then
          echo "âŒ Jira í•˜ìœ„ íƒœìŠ¤í¬ ìƒì„± ì‹¤íŒ¨"
          echo "ì—ëŸ¬ ë©”ì‹œì§€: $ERROR_MESSAGE"
          echo "ì „ì²´ ì‘ë‹µ: $RESPONSE"
          exit 1
        fi
        
        echo "JIRA_KEY=$JIRA_KEY" >> $GITHUB_OUTPUT
        echo "âœ… Jira í•˜ìœ„ íƒœìŠ¤í¬ ìƒì„± ì™„ë£Œ: $JIRA_KEY"

    - name: Update GitHub Issue with Success
      if: success()
      run: |
        JIRA_KEY="${{ steps.create-subtask.outputs.JIRA_KEY }}"
        PARENT_KEY="${{ steps.parse.outputs.PARENT_TICKET }}"
        JIRA_URL="${{ secrets.JIRA_BASE_URL }}/browse/$JIRA_KEY"
        PARENT_URL="${{ secrets.JIRA_BASE_URL }}/browse/$PARENT_KEY"
        
        # ì„±ê³µ ëŒ“ê¸€ ì¶”ê°€
        curl -X POST \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d '{
            "body": "ğŸ‰ **Jira ì—°ë™ ì™„ë£Œ!**\n\nğŸ“‹ **ìƒì„±ëœ í•˜ìœ„ íƒœìŠ¤í¬**: ['$JIRA_KEY']('$JIRA_URL')\nğŸ“Š **ìƒìœ„ íƒœìŠ¤í¬**: ['$PARENT_KEY']('$PARENT_URL')\n\n> ğŸ’¡ ì´ì œ Jiraì—ì„œ í•´ë‹¹ í•˜ìœ„ íƒœìŠ¤í¬ë¡œ ë¸Œëœì¹˜ë¥¼ ìƒì„±í•˜ê³  ì‘ì—…ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!"
          }' \
          "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments"
        
        # jira-linked ë¼ë²¨ ì¶”ê°€
        curl -X POST \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d '["jira-linked"]' \
          "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/labels"

    - name: Update GitHub Issue with Failure
      if: failure()
      run: |
        # ì‹¤íŒ¨ ëŒ“ê¸€ ì¶”ê°€
        curl -X POST \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d '{
            "body": "âŒ **Jira ì—°ë™ ì‹¤íŒ¨**\n\në‹¤ìŒ ì‚¬í•­ì„ í™•ì¸í•´ì£¼ì„¸ìš”:\n- ìƒìœ„ Jira í‹°ì¼“ í‚¤ê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸\n- Jira í”„ë¡œì íŠ¸ ê¶Œí•œì´ ìˆëŠ”ì§€ í™•ì¸\n- ë‹´ë‹¹ì ì´ë©”ì¼ì´ ì •í™•í•œì§€ í™•ì¸\n\nğŸ” ìì„¸í•œ ì˜¤ë¥˜ ë‚´ìš©ì€ [Actions ë¡œê·¸](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})ë¥¼ í™•ì¸í•˜ì„¸ìš”."
          }' \
          "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments"
